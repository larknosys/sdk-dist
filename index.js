"use strict";var e=require("@ntks/toolbox"),t=require("path"),a=require("@larksuiteoapi/node-sdk"),n=require("@knosys/sdk"),o=require("fs");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(a){if("default"!==a){var n=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,n.get?n:{enumerable:!0,get:function(){return e[a]}})}}),t.default=e,Object.freeze(t)}var r=s(a);const i={};function c(e){return i[e]}const l=function(e=200){const t=[];let a=!1;const n=async()=>{if(a||0===t.length)return;a=!0;const o=t.shift();o&&(await o(),await new Promise(t=>setTimeout(t,e))),a=!1,n()};return e=>new Promise((a,o)=>{t.push(async()=>{try{const t=await e();a(t)}catch(e){o(e)}}),n()})}();function p(){return n.resolvePathFromRootRelative("data")}function d(){const e=p();return"true"===process.env.KNOSYS_LARK_BACKUP_RAW_DIR_ENABLED?t.join(e,"raw"):e}function u(e={code:-1,msg:"unknown error"}){console.log(`[SYNC LARK ERROR] ${e.code}: ${e.msg||"unknown error"}`)}async function f(e){const t=await e.wiki.space.list({params:{lang:"zh"}});return 0===t.code&&t.data?.items||[]}async function m(e,t,a){const n={path:{space_id:t},params:{page_size:50}};a&&(n.params={...n.params,parent_node_token:a});const o=await e.wiki.spaceNode.list(n);if(0!==o.code)return u(o),[];const s=[];for(const a of o.data?.items||[])if(s.push(a),a.has_child){console.log(`获取「${a.title}」的子节点`);const n=await m(e,t,a.node_token);s.push(...n)}return s}async function g(e,t,a,n){return(await m(t,a,n)).filter(({obj_type:t})=>t&&e.includes(t))}const h=g.bind(null,["doc","docx"]),_=g.bind(null,["bitable"]);async function y(e,a,o){const s=await e.wiki.space.get({path:{space_id:a},params:{lang:"zh"}});if(0===s.code){const r=t.join(d(),"spaces",a);n.ensureDirExists(r,!0),n.saveData(`${r}/basic.yml`,s.data?.space),await Promise.resolve(o(e,a))}}async function $(e,t){const a=await m(e,t),n=[],o=[];a.forEach(e=>{"bitable"===e.obj_type?n.push(e):["doc","docx"].includes(e.obj_type)&&o.push(e)}),n.length>0&&await D(e,n),o.length>0&&await v(e,o)}async function v(e,a){if(0===a.length)return;const o=t.join(d(),"docs");for(const s of a){const a=s.obj_token,r=t.join(o,a),i=t.join(r,"basic.yml"),c=n.readData(i);c&&c.obj_edit_time===s.obj_edit_time?console.log(`「${s.title}」的飞书数据未更新，跳过`):(n.ensureDirExists(r,!0),n.saveData(i,s),await l(async()=>{console.log(`获取「${s.title}」的文档纯文本内容`);const t=await e.docx.document.rawContent({path:{document_id:a}});if(0===t.code){n.saveData(`${r}/readme.md`,t.data?.content),console.log(`获取「${s.title}」的文档所有块`);const o=await e.docx.documentBlock.list({path:{document_id:a},params:{page_size:500}});0===o.code?n.saveData(`${r}/blocks.yml`,o.data?.items):u(o)}else u(t)}))}}async function D(e,a){if(0===a.length)return;const o=t.join(d(),"bases");for(const s of a){const a=s.obj_token,r=t.join(o,a),i=t.join(r,"basic.yml"),c=n.readData(i);if(c&&c.obj_edit_time===s.obj_edit_time){console.log(`「${s.title}」的飞书数据未更新，跳过`);continue}n.ensureDirExists(r,!0),n.saveData(i,s),console.log(`获取「${s.title}」的数据表`);const l=await e.bitable.appTable.list({path:{app_token:a}});if(0===l.code){n.saveData(`${r}/tables.yml`,l.data?.items);for(const t of l.data?.items||[]){const o=t.table_id;console.log(`获取「${s.title}」中「${t.name}」的字段定义`);const i=await e.bitable.appTableField.list({path:{app_token:a,table_id:o},params:{page_size:100}});0===i.code?n.saveData(`${r}/table_${o}_fields.yml`,i.data?.items):u(i),console.log(`获取「${s.title}」中「${t.name}」的数据记录`);const c=[],l=async t=>{const n={page_size:500};return t&&(n.page_token=t),e.bitable.appTableRecord.list({path:{app_token:a,table_id:o},params:n})};let p=await l();if(0===p.code){if(p.data?.total&&p.data.total>0)for(c.push(...p.data?.items||[]);p.data?.has_more&&(p=await l(p.data.page_token),0===p.code);)c.push(...p.data?.items||[]);n.saveData(`${r}/table_${o}_records.yml`,c)}else u(p)}}else u(l)}}const b="messenger.json",w="data";function x(){return b}function E(){return n.readData(t.join(n.resolvePathFromRootRelative(n.LOCAL_DIR_NAME),b))}function j(e){return E()[e]}function k(){return w}function R(){return n.resolvePathFromRootRelative(w)}function P(){const e=j("name");if(!e)throw new Error("Messenger name is not set");return e}function N(e,a,s){const r=n.resolvePathFromRootRelative(".github/workflows"),i=t.join(r,`${e}-messenger-${s}.yml`);return 0===a.length?(o.existsSync(i)&&n.rm(i),""):(n.ensureDirExists(r),i)}exports.applyHook=function(t,a){const n=c(t);e.isFunction(n)&&n(...a)},exports.createLarkClient=function(e,t){if(!e||!t)throw new Error("[SYNC LARK ERROR] 请指定 App ID 和 App Secret");return new r.Client({appId:e,appSecret:t,appType:r.AppType.SelfBuild,domain:r.Domain.Feishu})},exports.ensureBackupDirExists=function(e=!1){n.ensureDirExists(d(),e)},exports.fetchSpaces=f,exports.getBitables=_,exports.getDocs=h,exports.getHook=c,exports.getMessengerConfig=E,exports.getMessengerConfigFileName=x,exports.getMessengerConfigValue=j,exports.getMessengerDataDirName=k,exports.getMessengerDataDirPath=R,exports.getSpaceNodes=m,exports.getSpaceNodesByType=g,exports.logErr=u,exports.receivePackage=function(a="",o={}){const s=n.resolvePathFromRootRelative(a),r=n.readData(t.join(s,n.LOCAL_DIR_NAME,x()));if(!r)throw new Error("Invalid sender config");if(!(j("sender")||[]).includes(r.name))throw new Error(`Invalid sender: ${r.name}`);const i=r.type||"qii";if("qii"!==i)throw new Error(`Invalid sender type: ${i}`);const c=r.collection,l=R(),p=t.join(l,r.name);if(o.readOne||n.ensureDirExists(p,!0),e.isArray(c)&&0===c.length)return;const d=r.dataSourceDir||"data",u=t.join(s,d),f=r.recordPath||n.readMeta(u)?.path||":collection/:id",m={...r,type:i,dataSourceDir:d,recordPath:f},g={dataSourceFullPath:u,localDataFullPath:l,localBackupFullPath:p},h=f.split("/").map(e=>e.slice(1)),_=h.join("/");n.readDirDeeply(u,h,{},(e,a)=>{if(!a.collection||c&&!c.includes(a.collection))return;const s=n.resolvePathFromParams(_,a),r=t.join(u,s),i=t.join(p,s);o.readOne?o.readOne(m,{...g,recordRelativePath:s,recordFullPath:r},a):(n.ensureDirExists(i),n.cp(`${r}/*`,`${i}/`))}),o.received&&o.received(m,g)},exports.registerHook=function(e,t){i[e]=t},exports.resolveBackupPath=d,exports.resolveDataPath=p,exports.syncBases=D,exports.syncDocs=v,exports.syncReceivers=function(){const e=P(),a=j("receiver")||[],o=N(e,a,"send");if(!o)return;const s=(r={name:e,dirName:k(),receivers:a.map(e=>e.repository)},n.readData(t.join(__dirname,"./send-template.yml"),!0).replace(/\$\$\$NAME/g,r.name).replace(/\$\$\$DIR_NAME/g,r.dirName).replace(/\$\$\$RECEIVERS/g,JSON.stringify(r.receivers)));var r;n.saveData(o,`${s}\n`)},exports.syncSenders=function(){const e=P(),a=j("sender")||[],o=N(e,a,"receive");if(!o)return;const s=(r={name:e,dirName:k(),senderEvents:a.map(e=>function(e){return`${e}-messenger-signal-changed`}(e))},n.readData(t.join(__dirname,"./receive-template.yml"),!0).replace(/\$\$\$NAME/g,r.name).replace(/\$\$\$DIR_NAME/g,r.dirName).replace(/\$\$\$SENDER_EVENTS/g,JSON.stringify(r.senderEvents)));var r;n.saveData(o,`${s}\n`)},exports.syncSpace=y,exports.syncSpaces=async function(t,a,n){let o;if(o=a||await f(t),0===o.length)return;let s=e.isFunction(n)?n:$;for(const a of o)e.isPlainObject(n)&&n[a.space_id]&&(s=n[a.space_id]),await y(t,a.space_id,s)};
