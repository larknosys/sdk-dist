"use strict";var e=require("@ntks/toolbox"),t=require("path"),n=require("@larksuiteoapi/node-sdk"),a=require("@knosys/sdk"),o=require("fs");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(n){if("default"!==n){var a=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,a.get?a:{enumerable:!0,get:function(){return e[n]}})}}),t.default=e,Object.freeze(t)}var r=s(n);const i={};function c(e){return i[e]}const l=function(e=200){const t=[];let n=!1;const a=async()=>{if(n||0===t.length)return;n=!0;const o=t.shift();o&&(await o(),await new Promise(t=>setTimeout(t,e))),n=!1,a()};return e=>new Promise((n,o)=>{t.push(async()=>{try{const t=await e();n(t)}catch(e){o(e)}}),a()})}();function p(){return a.resolvePathFromRootRelative("data")}function d(){const e=p();return"true"===process.env.KNOSYS_LARK_BACKUP_RAW_DIR_ENABLED?t.join(e,"raw"):e}function u(e={code:-1,msg:"unknown error"}){console.log(`[SYNC LARK ERROR] ${e.code}: ${e.msg||"unknown error"}`)}async function f(e){const t=await e.wiki.space.list({params:{lang:"zh"}});return 0===t.code&&t.data?.items||[]}async function m(e,t,n){const a={path:{space_id:t},params:{page_size:50}};n&&(a.params={...a.params,parent_node_token:n});const o=await e.wiki.spaceNode.list(a);if(0!==o.code)return u(o),[];const s=[];for(const n of o.data?.items||[])if(s.push(n),n.has_child){console.log(`获取「${n.title}」的子节点`);const a=await m(e,t,n.node_token);s.push(...a)}return s}async function g(e,t,n,a){return(await m(t,n,a)).filter(({obj_type:t})=>t&&e.includes(t))}const _=g.bind(null,["doc","docx"]),h=g.bind(null,["bitable"]);async function y(e,n,o){const s=await e.wiki.space.get({path:{space_id:n},params:{lang:"zh"}});if(0===s.code){const r=t.join(d(),"spaces",n);a.ensureDirExists(r,!0),a.saveData(`${r}/basic.yml`,s.data?.space),await Promise.resolve(o(e,n))}}async function $(e,t){const n=await m(e,t),a=[],o=[];n.forEach(e=>{"bitable"===e.obj_type?a.push(e):["doc","docx"].includes(e.obj_type)&&o.push(e)}),a.length>0&&await w(e,a),o.length>0&&await b(e,o)}async function b(e,n){if(0===n.length)return;const o=t.join(d(),"docs");for(const s of n){const n=s.obj_token,r=t.join(o,n),i=t.join(r,"basic.yml"),c=a.readData(i);c&&c.obj_edit_time===s.obj_edit_time?console.log(`「${s.title}」的飞书数据未更新，跳过`):(a.ensureDirExists(r,!0),a.saveData(i,s),await l(async()=>{console.log(`获取「${s.title}」的文档纯文本内容`);const t=await e.docx.document.rawContent({path:{document_id:n}});if(0===t.code){a.saveData(`${r}/readme.md`,t.data?.content),console.log(`获取「${s.title}」的文档所有块`);const o=await e.docx.documentBlock.list({path:{document_id:n},params:{page_size:500}});0===o.code?a.saveData(`${r}/blocks.yml`,o.data?.items):u(o)}else u(t)}))}}async function w(e,n){if(0===n.length)return;const o=t.join(d(),"bases");for(const s of n){const n=s.obj_token,r=t.join(o,n),i=t.join(r,"basic.yml"),c=a.readData(i);if(c&&c.obj_edit_time===s.obj_edit_time){console.log(`「${s.title}」的飞书数据未更新，跳过`);continue}a.ensureDirExists(r,!0),a.saveData(i,s),console.log(`获取「${s.title}」的数据表`);const l=await e.bitable.appTable.list({path:{app_token:n}});if(0===l.code){a.saveData(`${r}/tables.yml`,l.data?.items);for(const t of l.data?.items||[]){const o=t.table_id;console.log(`获取「${s.title}」中「${t.name}」的字段定义`);const i=await e.bitable.appTableField.list({path:{app_token:n,table_id:o},params:{page_size:100}});0===i.code?a.saveData(`${r}/table_${o}_fields.yml`,i.data?.items):u(i),console.log(`获取「${s.title}」中「${t.name}」的数据记录`);const c=[],l=async t=>{const a={page_size:500};return t&&(a.page_token=t),e.bitable.appTableRecord.list({path:{app_token:n,table_id:o},params:a})};let p=await l();if(0===p.code){if(p.data?.total&&p.data.total>0)for(c.push(...p.data?.items||[]);p.data?.has_more&&(p=await l(p.data.page_token),0===p.code);)c.push(...p.data?.items||[]);a.saveData(`${r}/table_${o}_records.yml`,c)}else u(p)}}else u(l)}}const D="messenger.json",v="data";function x(){return D}function E(){return a.readData(t.join(a.resolvePathFromRootRelative(a.LOCAL_DIR_NAME),D))}function j(e){return E()[e]}function k(){return v}function R(){return a.resolvePathFromRootRelative(v)}function N(){const e=j("name");if(!e)throw new Error("Messenger name is not set");return e}function S(e,n,s){const r=a.resolvePathFromRootRelative(".github/workflows"),i=t.join(r,`${e}-messenger-${s}.yml`);return 0===n.length?(o.existsSync(i)&&a.rm(i),""):(a.ensureDirExists(r),i)}exports.applyHook=function(t,n){const a=c(t);e.isFunction(a)&&a(...n)},exports.createLarkClient=function(e,t){if(!e||!t)throw new Error("[SYNC LARK ERROR] 请指定 App ID 和 App Secret");return new r.Client({appId:e,appSecret:t,appType:r.AppType.SelfBuild,domain:r.Domain.Feishu})},exports.ensureBackupDirExists=function(e=!1){a.ensureDirExists(d(),e)},exports.fetchSpaces=f,exports.getBitables=h,exports.getDocs=_,exports.getHook=c,exports.getMessengerConfig=E,exports.getMessengerConfigFileName=x,exports.getMessengerConfigValue=j,exports.getMessengerDataDirName=k,exports.getMessengerDataDirPath=R,exports.getSpaceNodes=m,exports.getSpaceNodesByType=g,exports.logErr=u,exports.receivePackage=function(n=""){const o=a.resolvePathFromRootRelative(n),s=a.readData(t.join(o,a.LOCAL_DIR_NAME,x()));if(!s)throw new Error("Invalid sender config");if(!(j("sender")||[]).includes(s.name))throw new Error(`Invalid sender: ${s.name}`);const r=s.type||"qii";if("qii"!==r)throw new Error(`Invalid sender type: ${r}`);const i=s.collection,c=t.join(R(),s.name);if(a.ensureDirExists(c,!0),e.isArray(i)&&0===i.length)return;const l=s.dataSourceDir||"data",p=t.join(o,l),d=(s.recordPath||a.readMeta(p)?.path||":collection/:id").split("/").map(e=>e.slice(1)),u=d.join("/");a.readDirDeeply(p,d,{},(e,n)=>{if(!n.collection||i&&!i.includes(n.collection))return;const o=a.resolvePathFromParams(u,n),s=t.join(p,o),r=t.join(c,o);a.ensureDirExists(r),a.cp(`${s}/*`,`${r}/`)})},exports.registerHook=function(e,t){i[e]=t},exports.resolveBackupPath=d,exports.resolveDataPath=p,exports.syncBases=w,exports.syncDocs=b,exports.syncReceivers=function(){const e=N(),n=j("receiver")||[],o=S(e,n,"send");if(!o)return;const s=(r={name:e,dirName:k(),receivers:n.map(e=>e.repository)},a.readData(t.join(__dirname,"./send-template.yml"),!0).replace(/\$\$\$NAME/g,r.name).replace(/\$\$\$DIR_NAME/g,r.dirName).replace(/\$\$\$RECEIVERS/g,JSON.stringify(r.receivers)));var r;a.saveData(o,`${s}\n`)},exports.syncSenders=function(){const e=N(),n=j("sender")||[],o=S(e,n,"receive");if(!o)return;const s=(r={name:e,dirName:k(),senderEvents:n.map(e=>function(e){return`${e}-messenger-signal-changed`}(e))},a.readData(t.join(__dirname,"./receive-template.yml"),!0).replace(/\$\$\$NAME/g,r.name).replace(/\$\$\$DIR_NAME/g,r.dirName).replace(/\$\$\$SENDER_EVENTS/g,JSON.stringify(r.senderEvents)));var r;a.saveData(o,`${s}\n`)},exports.syncSpace=y,exports.syncSpaces=async function(t,n,a){let o;if(o=n||await f(t),0===o.length)return;let s=e.isFunction(a)?a:$;for(const n of o)e.isPlainObject(a)&&a[n.space_id]&&(s=a[n.space_id]),await y(t,n.space_id,s)};
