"use strict";var e=require("@ntks/toolbox"),t=require("path"),a=require("@larksuiteoapi/node-sdk"),o=require("@knosys/sdk"),n=require("fs");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(a){if("default"!==a){var o=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,o.get?o:{enumerable:!0,get:function(){return e[a]}})}}),t.default=e,Object.freeze(t)}var i=s(a);const r={};function c(e){return r[e]}const l=function(e=200){const t=[];let a=!1;const o=async()=>{if(a||0===t.length)return;a=!0;const n=t.shift();n&&(await n(),await new Promise(t=>setTimeout(t,e))),a=!1,o()};return e=>new Promise((a,n)=>{t.push(async()=>{try{const t=await e();a(t)}catch(e){n(e)}}),o()})}();function p(){return o.resolvePathFromRootRelative("data")}function d(){const e=p();return"true"===process.env.KNOSYS_LARK_BACKUP_RAW_DIR_ENABLED?t.join(e,"raw"):e}function u(e={code:-1,msg:"unknown error"}){console.log(`[SYNC LARK ERROR] ${e.code}: ${e.msg||"unknown error"}`)}async function f(e){const t=await e.wiki.space.list({params:{lang:"zh"}});return 0===t.code&&t.data?.items||[]}async function m(e,t,a){const o={path:{space_id:t},params:{page_size:50}};a&&(o.params={...o.params,parent_node_token:a});const n=await e.wiki.spaceNode.list(o);if(0!==n.code)return u(n),[];const s=[];for(const a of n.data?.items||[])if(s.push(a),a.has_child){console.log(`获取「${a.title}」的子节点`);const o=await m(e,t,a.node_token);s.push(...o)}return s}async function g(e,t,a,o){return(await m(t,a,o)).filter(({obj_type:t})=>t&&e.includes(t))}const _=g.bind(null,["doc","docx"]),h=g.bind(null,["bitable"]);async function y(e,a,n){const s=await e.wiki.space.get({path:{space_id:a},params:{lang:"zh"}});if(0===s.code){const i=t.join(d(),"spaces",a);o.ensureDirExists(i,!0),o.saveData(`${i}/basic.yml`,s.data?.space),await Promise.resolve(n(e,a))}}async function b(e,t){const a=await m(e,t),o=[],n=[];a.forEach(e=>{"bitable"===e.obj_type?o.push(e):["doc","docx"].includes(e.obj_type)&&n.push(e)}),o.length>0&&await D(e,o),n.length>0&&await w(e,n)}async function w(e,a){if(0===a.length)return;const n=t.join(d(),"docs");for(const s of a){const a=s.obj_token,i=t.join(n,a),r=t.join(i,"basic.yml"),c=o.readData(r);c&&c.obj_edit_time===s.obj_edit_time?console.log(`「${s.title}」的飞书数据未更新，跳过`):(o.ensureDirExists(i,!0),o.saveData(r,s),await l(async()=>{console.log(`获取「${s.title}」的文档纯文本内容`);const t=await e.docx.document.rawContent({path:{document_id:a}});if(0===t.code){o.saveData(`${i}/readme.md`,t.data?.content),console.log(`获取「${s.title}」的文档所有块`);const n=await e.docx.documentBlock.list({path:{document_id:a},params:{page_size:500}});0===n.code?o.saveData(`${i}/blocks.yml`,n.data?.items):u(n)}else u(t)}))}}async function D(e,a){if(0===a.length)return;const n=t.join(d(),"bases");for(const s of a){const a=s.obj_token,i=t.join(n,a),r=t.join(i,"basic.yml"),c=o.readData(r);if(c&&c.obj_edit_time===s.obj_edit_time){console.log(`「${s.title}」的飞书数据未更新，跳过`);continue}o.ensureDirExists(i,!0),o.saveData(r,s),console.log(`获取「${s.title}」的数据表`);const l=await e.bitable.appTable.list({path:{app_token:a}});if(0===l.code){o.saveData(`${i}/tables.yml`,l.data?.items);for(const t of l.data?.items||[]){const n=t.table_id;console.log(`获取「${s.title}」中「${t.name}」的字段定义`);const r=await e.bitable.appTableField.list({path:{app_token:a,table_id:n},params:{page_size:100}});0===r.code?o.saveData(`${i}/table_${n}_fields.yml`,r.data?.items):u(r),console.log(`获取「${s.title}」中「${t.name}」的数据记录`);const c=[],l=async t=>{const o={page_size:500};return t&&(o.page_token=t),e.bitable.appTableRecord.list({path:{app_token:a,table_id:n},params:o})};let p=await l();if(0===p.code){if(p.data?.total&&p.data.total>0)for(c.push(...p.data?.items||[]);p.data?.has_more&&(p=await l(p.data.page_token),0===p.code);)c.push(...p.data?.items||[]);o.saveData(`${i}/table_${n}_records.yml`,c)}else u(p)}}else u(l)}}const x="messenger.json",v="data";function $(){return x}function j(){return o.readData(t.join(o.resolvePathFromRootRelative(o.LOCAL_DIR_NAME),x))}function k(e){return j()[e]}function R(){return v}function E(){return o.resolvePathFromRootRelative(v)}exports.applyHook=function(t,a){const o=c(t);e.isFunction(o)&&o(...a)},exports.createLarkClient=function(e,t){if(!e||!t)throw new Error("[SYNC LARK ERROR] 请指定 App ID 和 App Secret");return new i.Client({appId:e,appSecret:t,appType:i.AppType.SelfBuild,domain:i.Domain.Feishu})},exports.ensureBackupDirExists=function(e=!1){o.ensureDirExists(d(),e)},exports.fetchSpaces=f,exports.getBitables=h,exports.getDocs=_,exports.getHook=c,exports.getMessengerConfig=j,exports.getMessengerConfigFileName=$,exports.getMessengerConfigValue=k,exports.getMessengerDataDirName=R,exports.getMessengerDataDirPath=E,exports.getSpaceNodes=m,exports.getSpaceNodesByType=g,exports.logErr=u,exports.receivePackage=function(a=""){const n=o.resolvePathFromRootRelative(a),s=o.readData(t.join(n,o.LOCAL_DIR_NAME,$()));if(!s)throw new Error("Invalid sender config");if(!(k("sender")||[]).includes(s.name))throw new Error(`Invalid sender: ${s.name}`);const i=s.type||"qii";if("qii"!==i)throw new Error(`Invalid sender type: ${i}`);const r=s.collection,c=t.join(E(),s.name);if(o.ensureDirExists(c,!0),e.isArray(r)&&0===r.length)return;const l=s.dataSourceDir||"data",p=t.join(n,l),d=(s.recordPath||o.readMeta(p)?.path||":collection/:id").split("/").map(e=>e.slice(1)),u=d.join("/");o.readDirDeeply(p,d,{},(e,a)=>{if(!a.collection||r&&!r.includes(a.collection))return;const n=o.resolvePathFromParams(u,a),s=t.join(p,n),i=t.join(c,n);o.ensureDirExists(i),o.cp(`${s}/*`,`${i}/`)})},exports.registerHook=function(e,t){r[e]=t},exports.resolveBackupPath=d,exports.resolveDataPath=p,exports.syncBases=D,exports.syncDocs=w,exports.syncReceivers=function(){const e=k("name");if(!e)throw new Error("Messenger name is not set");const a=k("receiver")||[],s=o.resolvePathFromRootRelative(".github/workflows"),i=t.join(s,`${e}-messenger-send.yml`);var r;0!==a.length?(o.ensureDirExists(s),o.saveData(i,(r={name:e,receivers:a.map(e=>e.repository),dirName:R()},o.readData(t.join(__dirname,"./send-template.yml"),!0).replace(/\$\$\$NAME/g,r.name).replace(/\$\$\$RECEIVERS/g,JSON.stringify(r.receivers)).replace(/\$\$\$DIR_NAME/g,r.dirName)))):n.existsSync(i)&&o.rm(i)},exports.syncSpace=y,exports.syncSpaces=async function(t,a,o){let n;if(n=a||await f(t),0===n.length)return;let s=e.isFunction(o)?o:b;for(const a of n)e.isPlainObject(o)&&o[a.space_id]&&(s=o[a.space_id]),await y(t,a.space_id,s)};
