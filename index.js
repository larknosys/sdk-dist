"use strict";var e=require("path"),t=require("@larksuiteoapi/node-sdk"),a=require("@ntks/toolbox"),o=require("@knosys/sdk");function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(a){if("default"!==a){var o=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,o.get?o:{enumerable:!0,get:function(){return e[a]}})}}),t.default=e,Object.freeze(t)}var s=n(t);const i=function(e=200){const t=[];let a=!1;const o=async()=>{if(a||0===t.length)return;a=!0;const n=t.shift();n&&(await n(),await new Promise(t=>setTimeout(t,e))),a=!1,o()};return e=>new Promise((a,n)=>{t.push(async()=>{try{const t=await e();a(t)}catch(e){n(e)}}),o()})}();function r(){return o.resolvePathFromRootRelative("data")}function c(){const t=r();return"true"===process.env.KNOSYS_LARK_BACKUP_RAW_DIR_ENABLED?e.join(t,"raw"):t}function l(e={code:-1,msg:"unknown error"}){console.log(`[SYNC LARK ERROR] ${e.code}: ${e.msg||"unknown error"}`)}async function p(e){const t=await e.wiki.space.list({params:{lang:"zh"}});return 0===t.code&&t.data?.items||[]}async function d(e,t,a){const o={path:{space_id:t},params:{page_size:50}};a&&(o.params={...o.params,parent_node_token:a});const n=await e.wiki.spaceNode.list(o);if(0!==n.code)return l(n),[];const s=[];for(const a of n.data?.items||[])if(s.push(a),a.has_child){console.log(`获取「${a.title}」的子节点`);const o=await d(e,t,a.node_token);s.push(...o)}return s}async function u(e,t,a,o){return(await d(t,a,o)).filter(({obj_type:t})=>t&&e.includes(t))}const f=u.bind(null,["doc","docx"]),m=u.bind(null,["bitable"]);async function _(t,a,n){const s=await t.wiki.space.get({path:{space_id:a},params:{lang:"zh"}});if(0===s.code){const i=e.join(c(),"spaces",a);o.ensureDirExists(i,!0),o.saveData(`${i}/basic.yml`,s.data?.space),await Promise.resolve(n(t,a))}}async function g(e,t){const a=await d(e,t),o=[],n=[];a.forEach(e=>{"bitable"===e.obj_type?o.push(e):["doc","docx"].includes(e.obj_type)&&n.push(e)}),o.length>0&&await b(e,o),n.length>0&&await h(e,n)}async function h(t,a){if(0===a.length)return;const n=e.join(c(),"docs");for(const s of a){const a=s.obj_token,r=e.join(n,a),c=e.join(r,"basic.yml"),p=o.readData(c);p&&p.obj_edit_time===s.obj_edit_time?console.log(`「${s.title}」的飞书数据未更新，跳过`):(o.ensureDirExists(r,!0),o.saveData(c,s),await i(async()=>{console.log(`获取「${s.title}」的文档纯文本内容`);const e=await t.docx.document.rawContent({path:{document_id:a}});if(0===e.code){o.saveData(`${r}/readme.md`,e.data?.content),console.log(`获取「${s.title}」的文档所有块`);const n=await t.docx.documentBlock.list({path:{document_id:a},params:{page_size:500}});0===n.code?o.saveData(`${r}/blocks.yml`,n.data?.items):l(n)}else l(e)}))}}async function b(t,a){if(0===a.length)return;const n=e.join(c(),"bases");for(const s of a){const a=s.obj_token,i=e.join(n,a),r=e.join(i,"basic.yml"),c=o.readData(r);if(c&&c.obj_edit_time===s.obj_edit_time){console.log(`「${s.title}」的飞书数据未更新，跳过`);continue}o.ensureDirExists(i,!0),o.saveData(r,s),console.log(`获取「${s.title}」的数据表`);const p=await t.bitable.appTable.list({path:{app_token:a}});if(0===p.code){o.saveData(`${i}/tables.yml`,p.data?.items);for(const e of p.data?.items||[]){const n=e.table_id;console.log(`获取「${s.title}」中「${e.name}」的字段定义`);const r=await t.bitable.appTableField.list({path:{app_token:a,table_id:n},params:{page_size:100}});0===r.code?o.saveData(`${i}/table_${n}_fields.yml`,r.data?.items):l(r),console.log(`获取「${s.title}」中「${e.name}」的数据记录`);const c=[],p=async e=>{const o={page_size:500};return e&&(o.page_token=e),t.bitable.appTableRecord.list({path:{app_token:a,table_id:n},params:o})};let d=await p();if(0===d.code){if(d.data?.total&&d.data.total>0)for(c.push(...d.data?.items||[]);d.data?.has_more&&(d=await p(d.data.page_token),0===d.code);)c.push(...d.data?.items||[]);o.saveData(`${i}/table_${n}_records.yml`,c)}else l(d)}}else l(p)}}const w="messenger.json";function y(){return w}function D(){return o.readData(e.join(o.resolvePathFromRootRelative(o.LOCAL_DIR_NAME),w))}function j(e){return D()[e]}function x(){return o.resolvePathFromRootRelative("data")}exports.createLarkClient=function(e,t){if(!e||!t)throw new Error("[SYNC LARK ERROR] 请指定 App ID 和 App Secret");return new s.Client({appId:e,appSecret:t,appType:s.AppType.SelfBuild,domain:s.Domain.Feishu})},exports.ensureBackupDirExists=function(e=!1){o.ensureDirExists(c(),e)},exports.fetchSpaces=p,exports.getBitables=m,exports.getDocs=f,exports.getMessengerConfig=D,exports.getMessengerConfigFileName=y,exports.getMessengerConfigValue=j,exports.getMessengerDataDirPath=x,exports.getSpaceNodes=d,exports.getSpaceNodesByType=u,exports.logErr=l,exports.receivePackage=function(t=""){const n=o.resolvePathFromRootRelative(t),s=o.readData(e.join(n,o.LOCAL_DIR_NAME,y()));if(!s)throw new Error("Invalid sender config");if(!(j("sender")||[]).includes(s.name))throw new Error(`Invalid sender: ${s.name}`);const i=s.type||"qii";if("qii"!==i)throw new Error(`Invalid sender type: ${i}`);const r=s.collection,c=e.join(x(),s.name);if(o.ensureDirExists(c,!0),a.isArray(r)&&0===r.length)return;const l=s.dataSourceDir||"data",p=e.join(n,l),d=(s.recordPath||o.readMeta(p)?.path||":collection/:id").split("/").map(e=>e.slice(1)),u=d.join("/");o.readDirDeeply(p,d,{},(t,a)=>{if(!a.collection||r&&!r.includes(a.collection))return;const n=o.resolvePathFromParams(u,a),s=e.join(p,n),i=e.join(c,n);o.ensureDirExists(i),o.cp(`${s}/*`,`${i}/`)})},exports.resolveBackupPath=c,exports.resolveDataPath=r,exports.syncBases=b,exports.syncDocs=h,exports.syncSpace=_,exports.syncSpaces=async function(e,t,o){let n;if(n=t||await p(e),0===n.length)return;let s=a.isFunction(o)?o:g;for(const t of n)a.isPlainObject(o)&&o[t.space_id]&&(s=o[t.space_id]),await _(e,t.space_id,s)};
