"use strict";var e=require("path"),t=require("@larksuiteoapi/node-sdk"),a=require("@ntks/toolbox"),o=require("@knosys/sdk");function s(e){var t=Object.create(null);return e&&Object.keys(e).forEach(function(a){if("default"!==a){var o=Object.getOwnPropertyDescriptor(e,a);Object.defineProperty(t,a,o.get?o:{enumerable:!0,get:function(){return e[a]}})}}),t.default=e,Object.freeze(t)}var n=s(t);const{LOCAL_DIR_NAME:i,resolvePathFromRootRelative:c}=require("@knosys/sdk");const r=function(e=200){const t=[];let a=!1;const o=async()=>{if(a||0===t.length)return;a=!0;const s=t.shift();s&&(await s(),await new Promise(t=>setTimeout(t,e))),a=!1,o()};return e=>new Promise((a,s)=>{t.push(async()=>{try{const t=await e();a(t)}catch(e){s(e)}}),o()})}();function l(){return o.resolvePathFromRootRelative("data")}function p(){const t=l();return"true"===process.env.KNOSYS_LARK_BACKUP_RAW_DIR_ENABLED?e.join(t,"raw"):t}function d(e={code:-1,msg:"unknown error"}){console.log(`[SYNC LARK ERROR] ${e.code}: ${e.msg||"unknown error"}`)}async function u(e){const t=await e.wiki.space.list({params:{lang:"zh"}});return 0===t.code&&t.data?.items||[]}async function f(e,t,a){const o={path:{space_id:t},params:{page_size:50}};a&&(o.params={...o.params,parent_node_token:a});const s=await e.wiki.spaceNode.list(o);if(0!==s.code)return d(s),[];const n=[];for(const a of s.data?.items||[])if(n.push(a),a.has_child){console.log(`获取「${a.title}」的子节点`);const o=await f(e,t,a.node_token);n.push(...o)}return n}async function _(e,t,a,o){return(await f(t,a,o)).filter(({obj_type:t})=>t&&e.includes(t))}const m=_.bind(null,["doc","docx"]),b=_.bind(null,["bitable"]);async function h(t,a,s){const n=await t.wiki.space.get({path:{space_id:a},params:{lang:"zh"}});if(0===n.code){const i=e.join(p(),"spaces",a);o.ensureDirExists(i,!0),o.saveData(`${i}/basic.yml`,n.data?.space),await Promise.resolve(s(t,a))}}async function y(e,t){const a=await f(e,t),o=[],s=[];a.forEach(e=>{"bitable"===e.obj_type?o.push(e):["doc","docx"].includes(e.obj_type)&&s.push(e)}),o.length>0&&await w(e,o),s.length>0&&await g(e,s)}async function g(t,a){if(0===a.length)return;const s=e.join(p(),"docs");for(const n of a){const a=n.obj_token,i=e.join(s,a),c=e.join(i,"basic.yml"),l=o.readData(c);l&&l.obj_edit_time===n.obj_edit_time?console.log(`「${n.title}」的飞书数据未更新，跳过`):(o.ensureDirExists(i,!0),o.saveData(c,n),await r(async()=>{console.log(`获取「${n.title}」的文档纯文本内容`);const e=await t.docx.document.rawContent({path:{document_id:a}});if(0===e.code){o.saveData(`${i}/readme.md`,e.data?.content),console.log(`获取「${n.title}」的文档所有块`);const s=await t.docx.documentBlock.list({path:{document_id:a},params:{page_size:500}});0===s.code?o.saveData(`${i}/blocks.yml`,s.data?.items):d(s)}else d(e)}))}}async function w(t,a){if(0===a.length)return;const s=e.join(p(),"bases");for(const n of a){const a=n.obj_token,i=e.join(s,a),c=e.join(i,"basic.yml"),r=o.readData(c);if(r&&r.obj_edit_time===n.obj_edit_time){console.log(`「${n.title}」的飞书数据未更新，跳过`);continue}o.ensureDirExists(i,!0),o.saveData(c,n),console.log(`获取「${n.title}」的数据表`);const l=await t.bitable.appTable.list({path:{app_token:a}});if(0===l.code){o.saveData(`${i}/tables.yml`,l.data?.items);for(const e of l.data?.items||[]){const s=e.table_id;console.log(`获取「${n.title}」中「${e.name}」的字段定义`);const c=await t.bitable.appTableField.list({path:{app_token:a,table_id:s},params:{page_size:100}});0===c.code?o.saveData(`${i}/table_${s}_fields.yml`,c.data?.items):d(c),console.log(`获取「${n.title}」中「${e.name}」的数据记录`);const r=[],l=async e=>{const o={page_size:500};return e&&(o.page_token=e),t.bitable.appTableRecord.list({path:{app_token:a,table_id:s},params:o})};let p=await l();if(0===p.code){if(p.data?.total&&p.data.total>0)for(r.push(...p.data?.items||[]);p.data?.has_more&&(p=await l(p.data.page_token),0===p.code);)r.push(...p.data?.items||[]);o.saveData(`${i}/table_${s}_records.yml`,r)}else d(p)}}else d(l)}}exports.createLarkClient=function(e,t){if(!e||!t)throw new Error("[SYNC LARK ERROR] 请指定 App ID 和 App Secret");return new n.Client({appId:e,appSecret:t,appType:n.AppType.SelfBuild,domain:n.Domain.Feishu})},exports.ensureBackupDirExists=function(e=!1){o.ensureDirExists(p(),e)},exports.fetchSpaces=u,exports.getBitables=b,exports.getDocs=m,exports.getSpaceNodes=f,exports.getSpaceNodesByType=_,exports.logErr=d,exports.resolveBackupPath=p,exports.resolveDataPath=l,exports.syncBases=w,exports.syncDocs=g,exports.syncSpace=h,exports.syncSpaces=async function(e,t,o){let s;if(s=t||await u(e),0===s.length)return;let n=a.isFunction(o)?o:y;for(const t of s)a.isPlainObject(o)&&o[t.space_id]&&(n=o[t.space_id]),await h(e,t.space_id,n)};
